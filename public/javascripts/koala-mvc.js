Koala.models.add("event",Backbone.Model.extend({urlRoot:"/api/events",defaults:{title:"",stream:"",groups:null,starts_at:"",ends_at:"",matchup:null}})),Koala.models.add("group",Backbone.Model.extend({})),Koala.models.add("matchup",Backbone.Model.extend({urlRoot:"/api/matchups",defaults:{best_of:3,teams:[{name:"TBA"},{name:"TBA"}]}})),Koala.models.add("stream",Backbone.Model.extend({})),Koala.models.add("team",Backbone.Model.extend({})),Koala.models.add("warning",Backbone.Model.extend({defaults:{header:"",message:""}})),Koala.collections.add("events",Backbone.Collection.extend({model:Koala.models.get("event"),url:"/api/events"})),Koala.collections.add("groups",Backbone.Collection.extend({model:Koala.models.get("group"),url:"/api/groups"})),Koala.collections.add("matchups",Backbone.Collection.extend({model:Koala.models.get("matchup"),url:"/api/matchups"})),Koala.collections.add("streams",Backbone.Collection.extend({model:Koala.models.get("stream"),url:"/api/streams"})),Koala.collections.add("teams",Backbone.Collection.extend({model:Koala.models.get("team"),url:"/api/teams"})),Koala.views.add("confirm_delete_modal",Backbone.View.extend({tagName:"div",className:"modal hide fade",attributes:{role:"dialog","aria-hidden":"true"},events:{"click .confirm":function(){this.model.destroy()}},template:Koala.templates.get("confirm_modal"),initialize:function(){var e=this;this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.hide),this.$el.on("hidden",function(){e.destroy()}),$("body").append(this.render().el),$(this.$el).modal()},render:function(){return this.$el.html(this.template(this.options.modal)),this},hide:function(){this.$el.modal("hide")},destroy:function(){this.remove()}})),Koala.views.add("date_form",Backbone.View.extend({events:{"change .date, .time":"onChange","keyup .date, .time":"onChange","click .todayBtn":function(){$(".date",this.el).val(moment().format("L")).trigger("change")},"click .nowBtn":function(){$(".time",this.el).val(moment().format("HH:mm")).trigger("change")}},template:Koala.templates.get("date_form"),initialize:function(){this.Warning=Koala.models.new("warning"),this.warning_alert=Koala.views.new("warning",{model:this.Warning})},render:function(){return this.$el.html(this.template({data:this.initialValues(),type:this.options.type||""})),$(".date",this.el).datepicker({numberOfMonths:3}),$(".nowBtn, .todayBtn",this.el).tooltip({title:"Based on your computer's clock."}),$(".timeWarning .span4",this.el).append(this.warning_alert.el),this.warning(),this.delegateEvents(),this},initialValues:function(){var e=Date.parse(this.model.attributes[this.options.dateKey]);return{date:isNaN(e)?"":moment(e).format("L"),time:isNaN(e)?"":moment(e).format("HH:mm")}},generateDate:function(){var e=$(".date",this.el).val(),t=$(".time",this.el).val();return e&&t?moment(e+t,"MM-DD-YYYYTHH:mm").format():0/0},warning:function(){var e=this.generateDate();e?this.Warning.set({header:this.options.warningHeader,message:moment(e).calendar()}):this.Warning.set(this.Warning.defaults)},onChange:function(){this.trigger("change"),this.warning()}})),Koala.views.add("event_form",Backbone.View.extend({el:$("#event_form_target"),events:{"keyup #event_title":"setTitle"},template:Koala.templates.get("event_form"),initialize:function(){var e=Koala.collections.new("streams"),t=Koala.views.new("stream_select",{collection:e});e.fetch({fields:"id,name"});var a=Koala.collections.new("groups"),i=Koala.views.new("group_select",{collection:a});a.fetch({data:{fields:"id,name"}});var s=Koala.views.new("date_form",{model:this.model,dateKey:"starts_at",warningHeader:"Starting:",type:"Start"}),n=Koala.views.new("date_form",{model:this.model,dateKey:"ends_at",warningHeader:"Ending:",type:"End"});this.collections={streams:e,groups:a},this.views={stream_select:t,group_select:i,startDate_form:s,endDate_form:n},this.listenTo(e,"reset",this.prefill.setStreamIndex),this.listenTo(a,"reset",this.prefill.setGroupIndex),this.listenTo(t,"change",this.setStream),this.listenTo(i,"change",this.setGroups),this.listenTo(s,"change",this.setStarts_at),this.listenTo(n,"change",this.setEnds_at),this.model.isNew()&&this.listenTo(e,"reset",this.setStream)},render:function(){this.$el.html(this.template(this.model.attributes)),$("#event-stream-wrapper").append(this.views.stream_select.render().el),$("#event-group-wrapper").append(this.views.group_select.render().el),$("#startDate").replaceWith(this.views.startDate_form.render().el),$("#endDate").replaceWith(this.views.endDate_form.render().el);var e=this;$(this.views.endDate_form.el).off("click",".todayBtn"),$(".todayBtn",this.views.endDate_form.el).click(function(){var t=$(".date",e.views.startDate_form.el).val();$(".date",e.views.endDate_form.el).val(t).trigger("change")}).html("Same Day");for(var t in this.prefill)this.prefill[t].call(this);return this},prefill:{setStreamIndex:function(){this.views.stream_select.setIndex(this.model.attributes.stream.id)},setGroupIndex:function(){this.views.group_select.setIndex(this.model.attributes.groups)}},setTitle:function(){var e=$("#event_title",this.el).val();this.model.set({title:e}),this.save()},setStream:function(){var e=this.views.stream_select.getSelectedStream();this.model.set({stream:e}),this.save()},setGroups:function(){var e=this.views.group_select.getSelectedGroups();this.model.set({groups:e}),this.save()},setStarts_at:function(){var e=this.views.startDate_form.generateDate();this.model.set({starts_at:e}),this.save()},setEnds_at:function(){var e=this.views.endDate_form.generateDate();this.model.set({ends_at:e}),this.save()},save:function(){!this.model.isNew()&&this.model.hasChanged()&&this.model.save()}})),Koala.views.add("event_tbody",Backbone.View.extend({el:document.getElementById("eventsTable"),initialize:function(){this.listenTo(this.collection,"add",this.addOne),this.listenTo(this.collection,"reset",this.addAll)},addOne:function(e){var t=Koala.views.new("event_tr",{model:e});this.$el.append(t.render().el)},addAll:function(){this.collection.each(this.addOne,this)}})),Koala.views.add("event_tr",Backbone.View.extend({tagName:"tr",template:Koala.templates.get("event_tr"),events:{"click .delete":function(){Koala.views.new("confirm_delete_modal",{model:this.model,modal:{action:"Confirm Event Deletion.",message:"Are you sure you want to permanently delete this event?",snippet:this.model.attributes.title}})}},initialize:function(){this.listenTo(this.model,"change",this.render),this.listenTo(this.model,"destroy",this.destroy),this.data={};for(var e in this.model.attributes)this.model.attributes.hasOwnProperty(e)&&(this.data[e]=this.model.attributes[e]);this.data.starts_at=moment(this.model.attributes.starts_at).calendar(),this.data.franchise=this.model.attributes.groups[0]&&this.model.attributes.groups[0].name,this.data.status=this.status(this.model.attributes.starts_at,this.model.attributes.ends_at)},render:function(){return this.$el.html(this.template(this.data)),this},destroy:function(){this.remove()},status:function(e,t){var a=(new Date).getTime(),i=Date.parse(t),s=Date.parse(e);return a>i?"Complete":a>s?"Underway":a+18e5>s?"Starting Soon":"Pending"}})),Koala.views.add("group_option",Backbone.View.extend({tagName:"option",render:function(){return this.el.text=this.model.attributes.name,this.el.value=this.model.attributes.id,this}})),Koala.views.add("group_pill",Backbone.View.extend({tagName:"li",template:Koala.templates.get("group_pill"),initialize:function(){var e=this.model.get("active");e&&this.$el.addClass("active")},render:function(){var e=this.model.get("slug");return e?this.model.set("href",location.pathname+"?group="+this.model.get("slug")):this.model.set("href",location.pathname),this.$el.html(this.template(this.model.attributes)),this}})),Koala.views.add("group_pills",Backbone.View.extend({tagName:"ul",className:"nav nav-pills",initialize:function(){this.listenTo(this.collection,"reset",this.addAll)},addOne:function(e){var t=Koala.views.new("group_pill",{model:e});this.$el.append(t.render().el)},addAll:function(){var e=Koala.models.new("group",{name:"All"});this.collection.add(e,{silent:!0,at:0});var t=location.search.replace(/^\?.*group=([^&]*).*$/gi,"$1");if(t){var a=this.collection.find(function(e){return e.get("slug")===t});a&&a.set("active",!0)}else e.set("active",!0);this.collection.each(this.addOne,this)}})),Koala.views.add("group_select",Backbone.View.extend({tagName:"select",className:"span3",id:"group_select",attributes:{multiple:"multiple"},events:{change:"onChange"},initialize:function(){this.listenTo(this.collection,"reset",this.addAll)},addOne:function(e){var t=Koala.views.new("group_option",{model:e});this.$el.append(t.render().el)},addAll:function(){this.collection.each(this.addOne,this)},setIndex:function(e){if(e&&e.length){for(var t={},a=0,i=e.length;i>a;a++)t[e[a].id]=e[a].name;for(var a=0,i=this.el.options.length;i>a;a++){var s=this.el.options[a];t[s.value]&&(s.selected=!0)}}},getSelectedGroups:function(){for(var e=[],t=this.el.options,a=0,i=t.length;i>a;a++)t[a].selected&&e.push({id:t[a].value});return e},onChange:function(){this.trigger("change")}})),Koala.views.add("matchup_form",Backbone.View.extend({el:$("#matchup_form_target"),events:{"click #bestOf li":"changeBestOf"},template:Koala.templates.get("matchup_form"),initialize:function(){var e=Koala.collections.new("teams"),t=Koala.views.new("team_typeahead",{collection:e}),a=Koala.views.new("team_typeahead",{collection:e});e.fetch({data:{fields:"id,name",per_page:1e3}}),this.Teams=e,this.teamA_typeahead=t,this.teamB_typeahead=a,this.listenTo(this.teamA_typeahead,"change",this.changeTeams),this.listenTo(this.teamB_typeahead,"change",this.changeTeams),this.model.isNew()&&this.listenTo(e,"reset",this.changeTeams)},render:function(){return this.$el.html(this.template(this.model.attributes)),$(".teamA",this.el).append(this.teamA_typeahead.el),$(".teamB",this.el).append(this.teamB_typeahead.el),this.fillTeams(),this},fillTeams:function(){var e=this.model.get("teams"),t=e.shift(),a=e.shift();this.teamA_typeahead.setValue(t&&t.name||"TBA"),this.teamB_typeahead.setValue(a&&a.name||"TBA"),t&&a||this.changeTeams()},changeBestOf:function(e){$(e.currentTarget).hasClass("active")||($("#bestOf li.active",this.el).removeClass("active"),$(e.currentTarget).addClass("active"),this.model.set("best_of",$("a",e.currentTarget).html()),this.save())},changeTeams:function(){var e=[];e.push(this.teamA_typeahead.getTeam()),e.push(this.teamB_typeahead.getTeam()),this.model.set("teams",e),this.save()},save:function(){!this.model.isNew()&&this.model.hasChanged()&&this.model.save()}})),Koala.views.add("stream_option",Backbone.View.extend({tagName:"option",render:function(){return this.el.text=this.model.attributes.name,this.el.value=this.model.attributes.id,this}})),Koala.views.add("stream_select",Backbone.View.extend({tagName:"select",className:"span3",id:"stream_select",events:{change:"onChange"},initialize:function(){this.listenTo(this.collection,"reset",this.addAll)},addOne:function(e){var t=Koala.views.new("stream_option",{model:e});this.$el.append(t.render().el)},addAll:function(){this.collection.each(this.addOne,this)},setIndex:function(e){if(e)for(var t=0,a=this.el.options.length;a>t;t++){var i=this.el.options[t];if(i.value===e){i.selected=!0;break}}},getSelectedStream:function(){var e=$(this.el.selectedOptions[0]).val();if(e)return{id:e}},onChange:function(){this.trigger("change")}})),Koala.views.add("team_typeahead",Backbone.View.extend({tagName:"input",className:"span3 team_typeahead",attributes:{type:"text",placeholder:"Enter a team name..."},events:{change:"onChange",keyup:"onChange"},initialize:function(){this.listenTo(this.collection,"reset",this.bindTypeahead)},bindTypeahead:function(){this.$el.typeahead({source:this.collection.pluck("name")})},onChange:function(){this.trigger("change")},setValue:function(e){this.$el.val(e)},getTeam:function(){var e=this.$el.val(),t=this.collection.find(function(t){return t.get("name")===e});return t?{id:t.get("id")}:void 0}})),Koala.views.add("warning",Backbone.View.extend({className:"alert",template:Koala.templates.get("warning"),initialize:function(){this.listenTo(this.model,"change",this.render),this.render()},render:function(){""===this.model.attributes.header?this.$el.hide():this.$el.show(),this.$el.html(this.template(this.model.attributes))}}));